name: .NET CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:

jobs:
  test:
    runs-on: windows-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_NOLOGO: 1
      COVERAGE_THRESHOLD: 80

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Test (with XPlat coverage)
        run: dotnet test -c Release --no-build --settings coverlet.runsettings

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Combine coverage & generate report
        shell: pwsh
        run: |
          $files = Get-ChildItem -Recurse -Filter 'coverage.cobertura.xml'
          if (-not $files) {
            Write-Host "::warning title=Coverage not found::No coverage reports were produced."
            exit 0
          }
          reportgenerator `
            -reports:"./**/TestResults/**/coverage.cobertura.xml" `
            -targetdir:"./CoverageReport" `
            -reporttypes:"Html;TextSummary"

      - name: Warn if coverage < threshold
        if: always()
        shell: pwsh
        run: |
          $summary = Get-Content "./CoverageReport/Summary.txt" -Raw
          $m = Select-String -InputObject $summary -Pattern 'Line coverage:\s*([0-9]+(?:\.[0-9]+)?)%' | ForEach-Object { $_.Matches[0].Groups[1].Value }
          if (-not $m) { Write-Host "::warning::Coverage parse issue"; exit 0 }
          [double]$pct = $m
          $threshold = [double]"${{ env.COVERAGE_THRESHOLD }}"
          if ($pct -lt $threshold) { Write-Host "::warning::Line coverage $pct% < $threshold%." }
          "line_coverage=$pct" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: CoverageReport
          path: CoverageReport
